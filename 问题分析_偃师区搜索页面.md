# 偃师区搜索页面抓取问题分析与解决方案

## 🔍 问题描述

在抓取 `https://www.yanshi.gov.cn/yanshi/search.html?keyword=耕地地力` 时，无法正确获取搜索结果的标题和链接。

**实际获取到的错误数据**：
```
1,行政审批和政务信息管理局,https://www.yanshi.gov.cn/yanshi/bumen/37.html
2,"槐新街道办 伊洛街道办 商城街道办",
3,涧西区人民政府,http://www.jxq.gov.cn/
```

**期望获取的正确数据**：
```
1,洛阳市偃师区2025年耕地地力保护补贴发放结果公示,https://www.yanshi.gov.cn/yanshi/detail/62810.html
2,偃师区2025年耕地地力保护补贴申请指南,https://www.yanshi.gov.cn/yanshi/detail/62808.html
3,偃师区2024年耕地地力保护补贴发放情况公示,https://www.yanshi.gov.cn/yanshi/detail/55122.html
```

---

## 🔎 问题分析

### 页面结构分析

通过浏览器工具分析，发现页面存在**多个列表容器**，插件可能识别了错误的列表：

1. **导航菜单列表** (`#headBanner`) - 包含"网站首页"、"夏都商韵"等导航链接
2. **搜索结果列表** (`ul` 无特定标识) - 包含10个搜索结果项 ✅ **这是正确的列表**
3. **分页列表** (`.pagination`) - 包含分页按钮
4. **底部链接列表** - 包含"网站声明"、"联系我们"等

### 搜索结果项结构

每个搜索结果项 (`<li>`) 包含**3个链接**：

```html
<li>
  <!-- 链接1：标题链接（正确）✅ -->
  <a href="/yanshi/detail/62810.html" title="洛阳市偃师区2025年耕地地力保护补贴发放结果公示">
    <span class="lanmu">涉农补贴</span>
    洛阳市偃师区2025年耕地地力保护补贴发放结果公示
    <div>2025-07-11</div>
  </a>
  
  <!-- 链接2：摘要链接（错误）❌ -->
  <a href="/yanshi/detail/62810.html">
    2025年上级下达我区2025年耕地地力保护补贴资金3812.36万元...
  </a>
  
  <!-- 链接3：URL链接 -->
  <a href="/yanshi/detail/62810.html">http://yanshi.gov.cn/yanshi/detail/62810.html</a>
</li>
```

### 问题根源

1. **列表容器识别错误**：插件可能识别了导航菜单 (`#headBanner`) 或其他列表，而不是搜索结果列表
2. **链接提取错误**：如果识别了正确的列表，但提取了第二个链接（摘要）而不是第一个链接（标题）

---

## ✅ 解决方案

### 方案1：手动指定正确的选择器（推荐）

在插件中创建抓取器时，**手动指定选择器**：

#### 列表容器选择器
```
ul:not(#headBanner):not(.pagination)
```

**说明**：
- 选择 `<ul>` 标签
- 排除 `id="headBanner"` 的导航菜单
- 排除 `class="pagination"` 的分页列表

#### 列表项选择器
```
li
```

#### 标题链接选择器
```
li > a:first-child
```

**说明**：
- 选择每个 `<li>` 的第一个 `<a>` 子元素
- 这是包含标题的链接

#### 标题文本提取

从第一个链接中提取标题时，需要**清理文本**：
- 去掉分类标签（如"涉农补贴"）
- 去掉日期（如"2025-07-11"）
- 只保留标题文本

**提取逻辑**：
```javascript
// 获取第一个链接的文本
const titleLink = item.querySelector('li > a:first-child');
let title = titleLink.textContent.trim();

// 清理文本：去掉分类和日期
title = title
  .replace(/涉农补贴|单位政务公开|财政审计/g, '') // 去掉分类
  .replace(/\d{4}-\d{2}-\d{2}/g, '') // 去掉日期
  .replace(/\s+/g, ' ') // 合并多个空格
  .trim();
```

---

### 方案2：改进插件的智能识别算法

#### 改进列表容器识别逻辑

```javascript
function findSearchResultList() {
  // 1. 查找包含"当前搜索到"文本的容器
  const searchArea = Array.from(document.querySelectorAll('*')).find(el => 
    el.textContent && el.textContent.includes('当前搜索到')
  );
  
  if (!searchArea) return null;
  
  // 2. 在搜索结果区域中查找列表
  const lists = Array.from(searchArea.querySelectorAll('ul'));
  
  // 3. 过滤掉导航菜单、分页列表等
  const resultList = lists.find(ul => {
    // 排除导航菜单
    if (ul.id === 'headBanner') return false;
    // 排除分页列表
    if (ul.classList.contains('pagination')) return false;
    // 排除底部链接
    if (ul.textContent.includes('网站声明') || ul.textContent.includes('联系我们')) return false;
    // 应该是包含多个结果项的列表（至少5个）
    return ul.querySelectorAll('li').length >= 5;
  });
  
  return resultList;
}
```

#### 改进标题提取逻辑

```javascript
function extractTitle(listItem) {
  // 优先选择第一个链接
  const firstLink = listItem.querySelector('li > a:first-child');
  if (!firstLink) return null;
  
  let title = firstLink.textContent.trim();
  
  // 清理文本
  title = title
    // 去掉常见的分类标签
    .replace(/涉农补贴|单位政务公开|财政审计|行政审批/g, '')
    // 去掉日期格式 YYYY-MM-DD
    .replace(/\d{4}-\d{2}-\d{2}/g, '')
    // 合并多个空格和换行
    .replace(/[\s\n\r]+/g, ' ')
    .trim();
  
  return title;
}
```

---

## 🛠️ 实际操作步骤

### 步骤1：在插件中创建抓取器

1. 访问搜索页面：`https://www.yanshi.gov.cn/yanshi/search.html?keyword=耕地地力`
2. 打开 Data Hunter Pro 插件
3. 点击 "+ 新猎手"
4. 选择"列表抓取器"

### 步骤2：配置选择器

如果插件支持手动输入选择器，请使用：

**列表容器**：
```
.list-box ul:not(#headBanner):not(.pagination)
```

或者更精确的：
```javascript
// 在控制台测试
const searchArea = Array.from(document.querySelectorAll('*')).find(el => 
  el.textContent && el.textContent.includes('当前搜索到')
);
const resultList = Array.from(searchArea.querySelectorAll('ul')).find(ul => 
  ul.id !== 'headBanner' && 
  !ul.classList.contains('pagination') && 
  ul.querySelectorAll('li').length >= 5
);
console.log(resultList); // 查看是否正确
```

**列表项**：
```
li
```

**标题链接**：
```
li > a:first-child
```

### 步骤3：测试抓取

1. 点击"开始抓取"
2. 检查结果是否正确
3. 如果标题包含分类和日期，需要手动清理或使用脚本处理

---

## 📊 正确的数据结构

**期望的数据格式**：

| 序号 | 标题 | 链接 |
|------|------|------|
| 1 | 洛阳市偃师区2025年耕地地力保护补贴发放结果公示 | https://www.yanshi.gov.cn/yanshi/detail/62810.html |
| 2 | 偃师区2025年耕地地力保护补贴申请指南 | https://www.yanshi.gov.cn/yanshi/detail/62808.html |
| 3 | 偃师区2024年耕地地力保护补贴发放情况公示 | https://www.yanshi.gov.cn/yanshi/detail/55122.html |

---

## 🔧 代码示例

### JavaScript 提取代码

```javascript
// 找到搜索结果列表
const searchArea = Array.from(document.querySelectorAll('*')).find(el => 
  el.textContent && el.textContent.includes('当前搜索到')
);

const resultList = Array.from(searchArea.querySelectorAll('ul')).find(ul => 
  ul.id !== 'headBanner' && 
  !ul.classList.contains('pagination') && 
  ul.querySelectorAll('li').length >= 5
);

// 提取所有结果
const results = Array.from(resultList.querySelectorAll('li')).map((li, index) => {
  const titleLink = li.querySelector('a:first-child');
  
  if (!titleLink) return null;
  
  // 提取标题（清理文本）
  let title = titleLink.textContent.trim()
    .replace(/涉农补贴|单位政务公开|财政审计/g, '')
    .replace(/\d{4}-\d{2}-\d{2}/g, '')
    .replace(/[\s\n\r]+/g, ' ')
    .trim();
  
  // 提取链接
  const href = titleLink.href;
  
  return {
    index: index + 1,
    title: title,
    href: href
  };
}).filter(item => item !== null);

console.log(results);
```

### Playwright 配置

如果使用 Playwright，配置如下：

```json
{
  "selectors": {
    "listContainer": ".list-box ul:not(#headBanner):not(.pagination)",
    "listItem": "li",
    "title": "li > a:first-child",
    "href": "li > a:first-child"
  },
  "dataCleaning": {
    "title": {
      "removePatterns": [
        "涉农补贴",
        "单位政务公开",
        "财政审计",
        "\\d{4}-\\d{2}-\\d{2}"
      ],
      "trimWhitespace": true
    }
  }
}
```

---

## 📝 总结

**问题原因**：
1. 页面存在多个列表容器，插件识别了错误的列表
2. 每个结果项包含多个链接，插件提取了错误的链接（摘要而不是标题）

**解决方案**：
1. 手动指定正确的选择器：`ul:not(#headBanner):not(.pagination)`
2. 使用第一个链接作为标题：`li > a:first-child`
3. 清理标题文本，去掉分类和日期

**建议**：
- 在插件中添加"排除选择器"功能，可以排除特定的列表
- 改进标题提取逻辑，优先选择第一个链接
- 添加文本清理功能，自动去掉分类和日期

---

**文档创建时间**：2025-01-XX  
**问题页面**：https://www.yanshi.gov.cn/yanshi/search.html?keyword=耕地地力  
**插件版本**：Data Hunter Pro v1.3.6

